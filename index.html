<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crach√° Digital ‚Äî Frente/Verso (offline + c√¢mera)</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#111111">

  <!-- iOS / Safari -->
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Crach√°">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <!-- LIBS LOCAIS (para offline) ‚Äî usar caminhos absolutos para casar com o SW -->
  <script src="/vendor/html5-qrcode.min.js" defer></script>
  <script src="/vendor/qrcode.min.js" defer></script>
  <script src="/vendor/html2canvas.min.js" defer></script>
  <script src="/vendor/jspdf.umd.min.js" defer></script>
  <script src="/vendor/JsBarcode.all.min.js" defer></script>

  <style>
 :root{
  --preview-scale: .38;
  --primary:#1e88e5; --text:#111; --muted:#9aa0a6;
  --card-w:638px; --card-h:1011px;

  /* BOT√ÉO ‚Äútamanho de polegar‚Äù */
  --fab-size: 72px;

  --qr-height: 260px;

  /* Paleta banners (transl√∫cidos/sem borda) */
  --ok-bg-rgb:   34,197,94;
  --warn-bg-rgb: 251,191,36;
  --err-bg-rgb:  239,68,68;
  --info-bg-rgb: 59,130,246;

  --ok-fg:#d7fde7;
  --warn-fg:#fff7da;
  --err-fg:#ffe7e7;
  --info-fg:#e7f0ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:#E8E6E6;margin:0;color:#111;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;

  /* Ancoragem est√°vel para n√£o ‚Äúdescer‚Äù ao virar */
  min-height:100dvh;
  display:flex;align-items:flex-start;justify-content:center;
  padding:12px;
  overflow-anchor:none;
}
.wrap{width:100%;max-width:1100px}

/* Cart√£o responsivo mantendo propor√ß√£o */
.preview-wrap{
  width:calc(var(--card-w)*var(--preview-scale));
  height:calc(var(--card-h)*var(--preview-scale));
  margin:0 auto;position:relative;perspective:1200px;
  transition:width .2s ease,height .2s ease;
  overflow:hidden;                    /* impede ‚Äúdescer‚Äù */
  contain:layout paint size;          /* evita empurr√µes */
}
.card-3d{position:absolute;inset:0;transform-style:preserve-3d;will-change:transform}

/* === Frente/Verso empilhados (o verso n√£o some) === */
.card,.back{
  position:absolute; inset:0;
  width:var(--card-w);height:var(--card-h);transform-origin:top left;
  backface-visibility:hidden;border-radius:28px;color:#fff;overflow:hidden;
  background:#333;background-size:cover;background-position:center;
  padding:14px;box-shadow:0 4px 12px rgba(0,0,0,.15);
  transform:translateZ(0) scale(var(--preview-scale)) rotateY(0deg);
  transition: transform .7s cubic-bezier(.2,.7,.2,1), opacity .25s ease;
  will-change: transform, opacity;
  z-index:1;
}
.back{
  transform:translateZ(0) scale(var(--preview-scale)) rotateY(180deg);
  opacity:0; z-index:1;
  display:grid; /* mant√©m layout do verso */
}
.card-3d.is-back .card{
  opacity:0; pointer-events:none;
  transform:translateZ(0) scale(var(--preview-scale)) rotateY(180deg);
  z-index:1;
}
.card-3d.is-back .back{
  opacity:1;
  transform:translateZ(0) scale(var(--preview-scale)) rotateY(0deg);
  z-index:2;
}

/* Fundo sempre no n√≠vel mais baixo */
.bg-layer{
  position:absolute;inset:0;background-size:cover;background-position:center;border-radius:28px;
  z-index:0;               /* <- antes era 1 */
  pointer-events:none;     /* n√£o bloqueia cliques */
}

/* Todo o conte√∫do acima do fundo */
.card > *:not(.bg-layer),
.back > *:not(.bg-layer){
  position:relative;
  z-index:2;
}
/* QR pode ficar um n√≠vel acima se quiser garantir */
.qr-section{ margin-top: 12px;margin-bottom: 54px;z-index:3; }

.brand-row{display:flex;justify-content:center;align-items:center;min-height:80px}
.logo-main{max-height:220px;max-width:90%;display:block;filter:brightness(1.05)}

.profile-block{display:grid;justify-items:center;row-gap:0;margin-top:-6px;padding:0 12px}
.photo{width:min(40%,240px);aspect-ratio:1/1;border-radius:999px;object-fit:cover;border:4px solid rgba(255,255,255,.85);background:rgba(255,255,255,.1)}
.info{position: relative; z-index: 4;text-align:center}
.name{font-size:clamp(20px,3.4vw,44px);font-weight:700;margin:12px 0 0;line-height:1.05;text-shadow:0 1px 4px rgba(0,0,0,.35)}
.name .name-2{display:block;opacity:.98}


    /* C√≥digo (memberId) ‚Äî texto simples sob o nome */
    .code{
      font-size:clamp(10px,1.8vw,14px);
      margin:6px 0 0; padding:0;
      opacity:.01; text-shadow:0 1px 2px rgba(0,0,0,.25);
      border:0; background:transparent; display:block;
      letter-spacing:.2px;
    }

    .qr-section{z-index:3;display:grid;place-items:center;padding:8px 4px;margin-top:-20px;margin-bottom:54px}
    .qr{
  display:inline-grid;               /* encolhe ao conte√∫do */
  background:#fff;
  border-radius:16px;
  padding:10px;                      /* padding uniforme */
  width:auto;                        /* n√£o for√ßa 200px/50% */
  justify-items:center;
  align-items:center;
  line-height:0;                     /* remove espa√ßo extra */
    }
    .qr img, .qr canvas{
  display:block;                     /* elimina espa√ßos invis√≠veis */
    }

    .barcode-rail{position:absolute;right:10px;top:5%;transform:translateY(-50%);z-index:2;pointer-events:none}
    .barcode-rot{display:inline-block;transform:rotate(-90deg);transform-origin:right center}

    .footer-row{z-index:1;display:flex;align-items:center;justify-content:center;gap:10px;padding:8px 10px;margin-bottom:10px;position:relative;flex-wrap:wrap}
    .foot-logo{max-height:60px;max-width:40%}
    .footer-text{font-size:12px;line-height:1.35;max-width:360px;text-shadow:0 1px 3px rgba(0,0,0,.35)}
    .protocol{position:absolute;bottom:-24px;left:50%;transform:translateX(-50%);font-size:10px;background:rgba(150,29,19,.9);padding:4px 10px;border-radius:8px;white-space:nowrap}

    /* FABs */
    .fab{
  position:absolute;
  right:18px;
  left:auto;
  bottom:18px;
  z-index:10;
  width:var(--fab-size);
  height:var(--fab-size);
  border-radius:999px;
  border:0;
  cursor:pointer;
  background:rgba(255,255,255,.92);
  color:#111;
  display:grid;
  place-items:center;
  box-shadow:0 8px 24px rgba(0,0,0,.25);
  transition:transform .15s ease,opacity .15s ease,background .2s;
  touch-action: manipulation;
}

/* Apenas o bot√£o da frente */
#cardFront .fab{
  right:auto;
  left:500px;
  top:750px;
  bottom:auto;   /* substitui o bottom padr√£o */
}

    .fab:hover{transform:translateY(-1px)}
    .fab svg{width:32px;height:32px;display:block}
    .fab.secondary{right:18px;left: auto;bottom: 18px;background:rgba(255,255,255,.92)}

    /* Verso com rolagem interna e barra oculta */
    .back .content-scroll{
      z-index:2;position:relative;overflow:auto;
      padding:16px;height:100%;
      -webkit-overflow-scrolling: touch;
      overscroll-beavior: contain;
      scrollbar-width: none;          /* Firefox: oculta a barra */
    }
    .back .content-scroll::-webkit-scrollbar{width:0;height:0} /* WebKit: oculta */

    .badge-panel{
      width:100%;max-width:600px;margin:0 auto;background:rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
      border-radius:16px;padding:16px;display:grid;gap:12px;color:#fff;font-family:'Inter',sans-serif
    }
    .badge-logo img{max-width:80%}
    .badge-status{font-size:13px;color:#f1f5f9;text-align:center;min-height:18px}

    .badge-form label{font-size:13px;color:#fff}
    .badge-form input,.badge-form button{
      width:100%;padding:12px;margin-top:6px;border-radius:14px;border:1px solid rgba(255,255,255,.24);
      font-size:14px;background:rgba(255,255,255,.10);color:#fff;outline:none;
      transition:border-color .2s,background .2s,box-shadow .2s;
    }
    .badge-form input:focus{border-color:#fff;box-shadow:0 0 0 2px rgba(255,255,255,.15) inset}
    .badge-form input[readonly]{background:rgba(255,255,255,.08);color:#e7e7e7}
    .badge-form button{background:#A40000;font-weight:600;cursor:pointer}
    .badge-form button:hover{background:#7a0000}
    .badge-msg{min-height:20px;text-align:center;font-weight:600;color:#e5e7eb}
    .badge-msg.error{color:#fecaca}

    /* Leitor: tamanho final padronizado (v√≠deo tamb√©m) */
    #reader{
      width:100%; height:var(--qr-height);
      border-radius:16px; background:rgba(255,255,255,.08);
      overflow:hidden;
    }

    /* -------- BANNERS (transl√∫cidos/sem borda) -------- */
    .pwa-banner{
  position:fixed;
  left:50%;
  transform:translateX(-50%) translateY(-12px);
  top:12px;
  z-index:9998;
  width:calc(var(--card-w) * var(--preview-scale));
  max-width:none;
  border-radius:14px;
  padding:12px 14px;
  box-shadow:0 20px 60px rgba(0,0,0,.22);
  display:none;
  opacity:0;
  transition:opacity .25s ease, transform .25s ease;
  font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:rgba(var(--info-bg-rgb), .28);
  backdrop-filter:blur(4px);

  /* üîπ Fonte responsiva */
  font-size: clamp(12px, 2.6vw, 16px);
}

    .pwa-banner.show{ display:block; opacity:1; transform:translateX(-50%) translateY(0); }
    .pwa-banner .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .pwa-banner .title{font-weight:600;display:flex;align-items:center;gap:8px}
    .pwa-banner .hint{opacity:.95}
    .pwa-banner .dot{width:10px;height:10px;border-radius:50%;display:inline-block;box-shadow:0 0 0 2px rgba(255,255,255,.35) inset}
    .pwa-banner .actions{display:flex;gap:8px;align-items:center}
    .pwa-banner button{border:0;border-radius:10px;padding:8px 12px;cursor:pointer;background:rgba(255,255,255,.12);color:#fff}
    .pwa-banner button.ghost{background:rgba(255,255,255,.08)}
    .pwa-banner.ok   { background:rgba(var(--ok-bg-rgb), .18);   color:var(--ok-fg); }
    .pwa-banner.warn { background:rgba(var(--warn-bg-rgb), .20); color:var(--warn-fg); }
    .pwa-banner.err  { background:rgba(var(--err-bg-rgb), .20);  color:var(--err-fg); }
    .pwa-banner.info { background:rgba(var(--info-bg-rgb), .18); color:var(--info-fg); }
    .pwa-banner.ok .dot{background:rgba(var(--ok-bg-rgb), .95)}
    .pwa-banner.warn .dot{background:rgba(var(--warn-bg-rgb), .95)}
    .pwa-banner.err .dot{background:rgba(var(--err-bg-rgb), .95)}
    .pwa-banner.info .dot{background:rgba(var(--info-bg-rgb), .95)}

    .pwa-banner .inline-form{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .pwa-banner input[type="text"]{
      padding:8px 10px;border-radius:10px;border:0;
      background:rgba(255,255,255,.12);color:inherit;min-width:200px;outline:none
    }

    /* Install banner transl√∫cido */
    .pwa-install-banner{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:16px;
  z-index:9997;
  width:calc(var(--card-w) * var(--preview-scale));
  max-width:none;
  background:rgba(var(--info-bg-rgb), .36);
  color:#e7f0ff;
  padding:12px 14px;
  border-radius:14px;
  box-shadow:0 20px 60px rgba(0,0,0,.22);
  display:none;
  opacity:0;
  transition:opacity .25s ease, transform .25s ease;
  backdrop-filter:blur(4px);

  /* üîπ Fonte responsiva */
  font-size: clamp(12px, 2.6vw, 16px);
}

    .pwa-install-banner.show{display:block;opacity:1}
    .pwa-install-banner .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pwa-install-banner button{border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
    .pwa-install-banner .install{background:rgba(255,255,255,.16);color:#fff}
    .pwa-install-banner .close{background:rgba(255,255,255,.08);color:#dbeafe}

    /* Toasts / Proc */
    .pwa-toasts{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:10000;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .pwa-toast{min-width:260px;max-width:90vw;background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);font:14px/1.35 system-ui;pointer-events:auto}
    .pwa-toast.success{background:#115e24}.pwa-toast.warn{background:#8a1d1d}.pwa-toast.info{background:#0b57d0}
    .pwa-toast .title{font-weight:600;margin-bottom:2px}

    .proc-bar{position:fixed;left:50%;transform:translateX(-50%);top:64px;z-index:10001;min-width:280px;max-width:90vw;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);font:14px/1.35 system-ui;color:#111;display:none}
    .proc-bar.show{display:block}
    .proc-pending{background:#fde68a;border:1px solid #f59e0b}
    .proc-success{background:#bbf7d0;border:1px solid #22c55e}
    .proc-queued{background:#dbeafe;border:1px solid #3b82f6}
    .proc-error{background:#fecaca;border:1px solid #ef4444}

    /* Loader overlay */
    .loader{position:fixed;inset:0;background:linear-gradient(180deg,#0f0f10,#1b1b1c);
      display:flex;align-items:center;justify-content:center;color:#fff;z-index:100000}
    .loader .dot{width:10px;height:10px;border-radius:50%;background:#fff;opacity:.85;animation:bounce .9s infinite alternate}
    .loader .dot:nth-child(2){margin:0 10px;animation-delay:.15s}
    .loader .dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{to{transform:translateY(-8px);opacity:1}}

    @media (max-width:1200px){ :root{ --preview-scale: .34 } }
    @media (max-width:920px){  :root{ --preview-scale: .30 } }
    @media (max-width:720px){  :root{ --preview-scale: .26 } }
    @media (max-width:600px){  :root{ --preview-scale: .22 } }
    @media (max-width:480px){  :root{ --preview-scale: .195 } }
    @media (max-width:400px){  :root{ --preview-scale: .175 } }
  </style>
</head>
<body>
  <!-- LOADING -->
  <div id="loader" class="loader" aria-live="polite" aria-busy="true">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>

  <div class="wrap">
    <div class="preview-wrap" id="previewWrap">
      <div class="card-3d" id="card3d">
        <!-- FRENTE -->
        <div class="card" id="cardFront" aria-label="Crach√° ‚Äî Frente">
          <div class="bg-layer" id="bg"></div>

          <!-- FAB frente -->
          <button class="fab" id="flipToBack" title="Registrar presen√ßa" aria-label="Registrar presen√ßa">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4.93 4.93a10 10 0 1 1 0 14.14"></path>
              <path d="M4 10v6h6"></path>
            </svg>
          </button>

          <div class="brand-row">
            <img class="logo-main" id="logoMain" alt="Logo principal">
          </div>

          <div class="profile-block">
            <img class="photo" id="pPhoto" alt="Foto">
            <div class="info">
              <h3 class="name" id="pName">Nome</h3>
              <!-- MEMBERID vis√≠vel abaixo do nome -->
              <p class="code" id="pCode">memberId</p>
            </div>
          </div>

          <div class="qr-section"><div class="qr" id="qr"></div></div>

          <div class="barcode-rail"><div class="barcode-rot"><svg id="barcode"></svg></div></div>

          <div class="footer-row">
            <img class="foot-logo" id="foot1" alt="Logo 1">
            <img class="foot-logo" id="foot2" alt="Logo 2">
            <div class="footer-text" id="footText">Crach√° digital pessoal e intransfer√≠vel, v√°lido somente para este evento.</div>
            <div class="protocol" id="protocolText"></div>
          </div>
        </div>

        <!-- VERSO -->
        <div class="back" id="cardBack" aria-label="Crach√° ‚Äî Verso">
          <div class="bg-layer" id="bgBack"></div>

          <!-- FAB verso -->
          <button class="fab secondary" id="flipToFront" style="display:none" title="Voltar ao crach√°" aria-label="Voltar ao crach√°">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>

          <!-- conte√∫do rol√°vel -->
          <div class="content-scroll">
            <div class="badge-panel">
              <div class="badge-logo">
                <img src="./logo-evento.png" alt="Logo do Evento" onerror="this.style.display='none'">
              </div>

              <div class="badge-status" id="statusBar"></div>

              <div class="badge-reader"><div id="reader"></div></div>

              <form id="form" class="badge-form" autocomplete="off">
                <label for="nome">Nome</label>
                <input type="text" id="nome" name="nome" placeholder="Nome" required readonly>

                <label for="codigo">C√≥digo (memberId)</label>
                <input type="text" id="codigo" name="codigo" placeholder="C√≥digo (memberId)" required readonly>

                <label for="evento">Evento (QR)</label>
                <input type="text" id="evento" name="evento" placeholder="Aproxime o QR do evento" required readonly inputmode="none">
                <div class="hint" style="font-size:12px;color:#e5e7eb;margin-top:6px">O evento s√≥ √© preenchido ao ler o QR Code do evento.</div>

                <button type="submit" id="enviarBtn">Enviar registro digital de presen√ßa</button>
              </form>

              <p id="msg" class="badge-msg"></p>

              <div id="lista-pendentes">
                <h3 style="margin:2px 0 6px">Registros pendentes de envio</h3>
                <div class="table-scroll" style="border:1px solid rgba(255,255,255,.25);border-radius:14px;overflow:hidden;background:rgba(0,0,0,.15)">
                  <table style="width:100%;border-collapse:collapse;color:#fff">
                    <thead>
                      <tr>
                        <th style="width:28%;padding:8px;background:rgba(0,0,0,.35);position:sticky;top:0">Data/Hora</th>
                        <th style="width:22%;padding:8px;background:rgba(0,0,0,.35);position:sticky;top:0">Nome</th>
                        <th style="width:18%;padding:8px;background:rgba(0,0,0,.35);position:sticky;top:0">C√≥digo</th>
                        <th style="width:22%;padding:8px;background:rgba(0,0,0,.35);position:sticky;top:0">Evento</th>
                        <th style="width:10%;padding:8px;background:rgba(0,0,0,.35);position:sticky;top:0">Status</th>
                      </tr>
                    </thead>
                    <tbody id="tabela-pendentes" style="display:block;max-height:170px;overflow:auto"></tbody>
                  </table>
                </div>
              </div>

              <div id="lista-registros" style="display:none">
                <h3>Presen√ßas Registradas</h3>
                <table>
                  <thead><tr><th>Data/Hora</th><th>Nome</th><th>C√≥digo</th><th>Evento</th></tr></thead>
                  <tbody id="tabela-registros"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div><!-- /back -->
      </div>
    </div>
  </div>

  <!-- Toasts / Proc -->
  <div id="pwaToasts" class="pwa-toasts" aria-live="polite" aria-atomic="true"></div>
  <div id="procBar" class="proc-bar" role="status" aria-live="polite"></div>

  <!-- Sync banner -->
  <div id="syncBanner" class="pwa-banner" role="region" aria-label="Sincroniza√ß√£o">
    <div class="row">
      <div class="title">
        <span class="dot" id="syncDot"></span>
        <span id="syncTitle">Sincroniza√ß√£o</span>
      </div>
      <div class="actions">
        <button id="syncNowBtn" class="ghost">Sincronizar</button>
        <button id="syncCloseBtn" class="ghost">Fechar</button>
      </div>
    </div>
    <div id="syncBannerMsg" class="hint" style="margin-top:6px">Verificando status‚Ä¶</div>

    <div id="manualNameWrap" class="inline-form" style="display:none">
      <label for="manualName" style="opacity:.95">Nome completo:</label>
      <input type="text" id="manualName" placeholder="Digite seu nome completo" />
      <button id="manualNameSave" class="ghost">Salvar</button>
    </div>
  </div>

  <!-- Install banner -->
  <div id="pwaBanner" class="pwa-install-banner" role="region" aria-label="Instalar aplicativo">
    <div class="row">
      <div>
        <div class="title">Instale ‚ÄúCrach√° Digital - IISNHCM‚Äù</div>
        <div id="pwaHint" class="hint"></div>
      </div>
      <div>
        <button id="pwaInstallBtn" class="install" style="display:none">Instalar app</button>
        <button id="pwaCloseBtn" class="close" aria-label="Fechar">Agora n√£o</button>
      </div>
    </div>
  </div>

  <audio id="bip" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    /* ========= CONFIG ========= */
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbwHk6o909wUncUcY0g0nRgJSpiZ-ZI7MtZjxMRCTrVU2yh9zm_M9uULA6SBYnTcuL0mEw/exec";
    window.ENDPOINT = ENDPOINT;
    const CARD_WIDTH=638, CARD_HEIGHT=1011, QR_SIZE=170;
    const px2mm = p => p * 0.264583;

    const supports3D = (typeof CSS!=='undefined' && CSS.supports && CSS.supports('transform-style','preserve-3d'));
    if (!supports3D) document.body.classList.add('no-3d');

    const BG_BASE64="imagem1"; // opcional base64
    const BG_BACK_BASE64 = "imagem2"; // NOVO: base64 do verso
    const LOGO_MAIN_BASE64   = "imagem3"; // Logo grande (topo)
    const LOGO_FOOTER1_BASE64= "imagem4"; // Logo rodap√© (esquerda)
    const LOGO_FOOTER2_BASE64= "imagem5"; // Logo rodap√© (direita)

    const currentData = { name:'', code:'', photoUrl:'' };
  </script>

  <!-- Utils + render -->
  <script>
    function sanitizeForBarcode(s){return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().replace(/[^A-Z0-9]/g,'');}
    function getInitials(n){return n? n.trim().split(' ').filter(Boolean).map(p=>p[0].toUpperCase()).join(''):'';}
    function makeProtocol(code,name){
      const d=new Date(),p=n=>String(n).padStart(2,'0');
      const ts=`${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}${p(d.getHours())}${p(d.getMinutes())}`;
      const clean=sanitizeForBarcode(code), half=Math.floor(clean.length/2);
      return `${ts}${clean.slice(0,half)}${getInitials(name)}${clean.slice(half)}`;
    }
    function escHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
    function splitNameTwoLines(name){
      const n=(name||'').trim(); if(!n) return 'Nome';
      const parts=n.split(/\s+/);
      if(parts.length<=2) return escHtml(n);
      const first=parts.slice(0,2).join(' '), rest=parts.slice(2).join(' ');
      return `${escHtml(first)}<br><span class="name-2">${escHtml(rest)}</span>`;
    }

    function safeRenderQR(){
      if(!window.QRCode) return;
      const cont=document.getElementById('qr'); if(!cont) return;
      cont.innerHTML='';
      new QRCode(cont,{text:JSON.stringify({nome:currentData.name||'Nome',codigo:currentData.code||''}),width:QR_SIZE,height:QR_SIZE});
    }
    function safeRenderBarcode(){
      const protocol=makeProtocol(currentData.code||'', currentData.name||'Nome');
      const protocolEl=document.getElementById('protocolText'); if(protocolEl) protocolEl.textContent=protocol;
      if(window.JsBarcode){
        const svg=document.getElementById('barcode');
        if(svg){ while(svg.firstChild) svg.removeChild(svg.firstChild);
          JsBarcode(svg,protocol,{format:"CODE128",lineColor:"#FFFFFF",background:"transparent",width:2,height:15,displayValue:false,margin:0});
        }
      }
    }
    function renderAll(){ safeRenderQR(); safeRenderBarcode(); }

    const isDataUrl=s=>/^data:image\/[a-zA-Z0-9.+-]+;base64,/.test(s||'');
    const isHttp=s=>/^(https?:)?\/\//.test(s||'');
    const isRel=s=>/^[./]/.test(s||'');
    const looksPureBase64=s=>!!s && /^[A-Za-z0-9+/=\s]+$/.test(s) && s.replace(/\s+/g,'').length>100;
    const toDataUrlIfNeeded=(src,mime='image/png')=>{
      if(!src) return null; if(isDataUrl(src)||isHttp(src)||isRel(src)) return src;
      if(looksPureBase64(src)) return `data:${mime};base64,${src.replace(/\s+/g,'')}`; return null;
    };
    function setImageSrcById(id,src){
      const el=document.getElementById(id); if(!el) return;
      const placeholder='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="600" height="220"><rect width="100%" height="100%" fill="#222"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif" font-size="28">LOGO</text></svg>');
      el.src=toDataUrlIfNeeded(src)||placeholder;
    }
    function setBgImageById(id,src){
      const el=document.getElementById(id); if(!el) return;
      const candidate=toDataUrlIfNeeded(src,'image/jpeg');
      if(candidate) el.style.backgroundImage=`url('${candidate}')`;
    }

    function fitPreviewToContainer(){
      const wrap=document.getElementById('previewWrap'); if(!wrap) return;
      const parentWidth=wrap.parentElement?wrap.parentElement.clientWidth:window.innerWidth;
      const parentHeight=window.innerHeight-24;
      const cw=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-w'));
      const ch=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-h'));
      const scaleByW=(parentWidth-16)/cw;
      const scaleByH=(parentHeight-16)/ch;
      const scale=Math.max(.16,Math.min(1,Math.min(scaleByW,scaleByH)));
      document.documentElement.style.setProperty('--preview-scale', String(scale));
      wrap.style.width=`calc(var(--card-w)*var(--preview-scale))`;
      wrap.style.height=`calc(var(--card-h)*var(--preview-scale))`;
    }
    window.addEventListener('resize',fitPreviewToContainer);
    window.addEventListener('orientationchange',fitPreviewToContainer);

    function setBadgeData(name,code,photoUrl){
      currentData.name=name||''; currentData.code=code||''; currentData.photoUrl=photoUrl||'';
      const nameEl=document.getElementById('pName'); if(nameEl) nameEl.innerHTML=splitNameTwoLines(currentData.name);
      const codeEl=document.getElementById('pCode'); if(codeEl) codeEl.textContent=currentData.code||'memberId';
      const img=document.getElementById('pPhoto'); if(img){ img.crossOrigin='anonymous';
        img.src=currentData.photoUrl||'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCI+PC9zdmc+';}
      renderAll();
    }

    async function prefillFromCacheThenURL(){
      try{ if(typeof window.loadUserProfile==='function'){
        const prof=await window.loadUserProfile();
        if(prof && prof.fullName && prof.memberId){ setBadgeData(prof.fullName,prof.memberId,prof.photoUrl); }
      }}catch{}
      try{
        const manual = localStorage.getItem('pwa:manualName');
        if (manual && !currentData.name) setBadgeData(manual, currentData.code, currentData.photoUrl);
      }catch{}
      const p=new URLSearchParams(location.search);
      const name=p.get('name')||p.get('nome')||'';
      const code=p.get('code')||p.get('memberid')||p.get('memberId')||p.get('matricula')||'';
      const photo=p.get('photo')||p.get('foto')||p.get('image')||'';
      if(name||code||photo) setBadgeData(name,code,photo);
    }
  </script>

  <!-- Verso / c√¢mera / envio -->
  <script>
    const card3d=document.getElementById('card3d');
    const wrapEl=document.getElementById('previewWrap');
    const flipToBack=document.getElementById('flipToBack');
    const flipToFront=document.getElementById('flipToFront');
    const form=document.getElementById('form');
    const nomeInput=document.getElementById('nome');
    const codigoInput=document.getElementById('codigo');
    const eventoInput=document.getElementById('evento');
    const statusBar=document.getElementById('statusBar');
    const msg=document.getElementById('msg');
    const registrosTabela=document.getElementById('tabela-registros');
    const bip=document.getElementById('bip');

    let eventoValido=false, qrInstance=null;

    /* Mant√©m o cart√£o no mesmo lugar ao virar (sem ‚Äúpulo‚Äù) */
    function flipKeepingViewport(fn){
      const y = window.scrollY || document.documentElement.scrollTop || 0;
      fn();
      requestAnimationFrame(()=>{
        if (document.activeElement && document.activeElement.blur) {
          try { document.activeElement.blur(); } catch {}
        }
        window.scrollTo(0, y);
      });
    }

    function showBack(){ card3d.classList.add('is-back'); flipToFront.style.display='inline-grid'; setTimeout(fitPreviewToContainer,50); }
    function showFront(){ card3d.classList.remove('is-back'); flipToFront.style.display='none'; setTimeout(fitPreviewToContainer,50); }

    flipToBack.addEventListener('click', ()=>{
      nomeInput.value=currentData.name||''; codigoInput.value=currentData.code||'';
      flipKeepingViewport(()=>{ showBack(); startQR(); });
      if(window.presenceQueueAPI && presenceQueueAPI.all){ dispatchEvent(new CustomEvent('presence:queued')); }
    });
    flipToFront.addEventListener('click', ()=>{ flipKeepingViewport(()=>{ showFront(); stopQR(); }); });

    ['keydown','keypress','keyup','paste','drop','input','focus'].forEach(evt=>{
      eventoInput.addEventListener(evt,e=>{
        if(evt!=='focus') e.preventDefault();
        if(evt==='focus') eventoInput.blur();
        return false;
      },true);
    });

    function setStatusOfflineUI(){
      statusBar.textContent = navigator.onLine ? "" : "Sem conex√£o ‚Äî os registros ser√£o enviados automaticamente quando a internet voltar.";
    }
    window.addEventListener('online', ()=>{ setStatusOfflineUI(); (window.flushPresenceQueue&&flushPresenceQueue().catch(()=>{})); updateSyncStatus(); });
    window.addEventListener('offline', ()=>{ setStatusOfflineUI(); updateSyncStatus(); });

    /* Tamanho fixo do v√≠deo do leitor ap√≥s carregar */
    function lockReaderVideoSize(){
      const v = document.querySelector('#reader video');
      if (v){
        v.style.width = '100%';
        v.style.height = 'var(--qr-height)';
        v.style.objectFit = 'cover';
        v.style.borderRadius = '16px';
        v.style.display = 'block';
      }
    }

    async function startQR(){
      try{
        if(!window.Html5Qrcode){ console.warn('html5-qrcode ainda n√£o carregado.'); return; }
        if(qrInstance) return;
        qrInstance=new Html5Qrcode("reader");
        await qrInstance.start({ facingMode:"environment" }, { fps:10, qrbox:250 }, onScanSuccess);
        lockReaderVideoSize(); setTimeout(lockReaderVideoSize, 300); setTimeout(lockReaderVideoSize, 900);
      }catch(e){ console.warn("Falha ao iniciar c√¢mera:", e); }
    }
    async function stopQR(){
      try{ if(qrInstance){ await qrInstance.stop(); await qrInstance.clear(); qrInstance=null; } }catch(e){}
    }
    function onScanSuccess(decodedText){
      try{
        const data=JSON.parse(decodedText);
        if(data && data.nome && data.codigo){
          eventoInput.value=`${data.nome} - ${data.codigo}`; eventoValido=true; try{bip.play();}catch{}
          mostrarMensagem("Evento lido com sucesso!", false);
        }else{ mostrarMensagem('QR inv√°lido. Esperado {"nome":"...","codigo":"..."}', true); }
      }catch(e){ mostrarMensagem("Leitura inv√°lida do QR.", true); }
    }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!eventoValido || !eventoInput.value.trim()){ mostrarMensagem("Leia o QR do evento para prosseguir.", true); return; }
      const registro={ nome:(nomeInput.value||"").trim(), codigo:(codigoInput.value||"").trim(), evento:(eventoInput.value||"").trim(), horario:new Date().toLocaleString("pt-BR") };
      window.PROC && PROC.pending('Aguarde: processando registro digital‚Ä¶');
      try{
        const res=await window.registerPresence(registro);
        if(res && res.ok){ mostrarMensagem("Presen√ßa registrada com sucesso!", false); try{bip&&bip.play();}catch{}; window.PROC&&PROC.success('Registro realizado com sucesso!'); }
        else{ mostrarMensagem("Sem conex√£o est√°vel. Registro salvo e ser√° enviado automaticamente.", true); window.PROC&&PROC.queued('Sem internet: registro ser√° enviado quando a conex√£o voltar.'); }
      }catch(err){
        console.warn('[PWA] Envio online falhou, enfileirando:', err);
        mostrarMensagem("N√£o foi poss√≠vel registrar agora. Salvamos e tentaremos novamente.", true);
        window.PROC&&PROC.queued('Registro salvo. Enviaremos quando a conex√£o voltar.');
      }
      eventoInput.value=""; eventoValido=false;
    });

    function exibirNaTabela(r){
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.horario}</td><td>${r.nome}</td><td>${r.codigo}</td><td>${r.evento}</td>`;
      registrosTabela && registrosTabela.prepend(tr);
    }
    function mostrarMensagem(t,err){ msg.textContent=t; msg.classList.toggle('error',!!err); }
  </script>

  <!-- Loader + bootstrap + sync -->
  <script>
    function hideLoader(){ const l=document.getElementById('loader'); if(l){ l.style.opacity='0'; l.style.transition='opacity .25s'; setTimeout(()=>l.remove(),250); } }

    async function bootstrap(){
      setBgImageById('bg', BG_BASE64);
      setBgImageById('bgBack', BG_BACK_BASE64);
      setImageSrcById('logoMain', LOGO_MAIN_BASE64);
      setImageSrcById('foot1', LOGO_FOOTER1_BASE64);
      setImageSrcById('foot2', LOGO_FOOTER2_BASE64);
      await prefillFromCacheThenURL();
      renderAll();
      fitPreviewToContainer();
      setStatusOfflineUI();

      setTimeout(hideLoader, 250);
      updateSyncStatus();
    }
    document.addEventListener('DOMContentLoaded', bootstrap);
  </script>

  <!-- Hidden reset (triple-click) -->
  <script>
    (function(){
      const crachaEl = document.querySelector('#cracha, #cardFront, .card');
      async function fallbackReset() {
        try { localStorage && localStorage.clear && localStorage.clear(); } catch {}
        try { if (window.caches && caches.keys) { const keys = await caches.keys(); await Promise.all(keys.map(k => caches.delete(k))); } } catch {}
        try { if ('serviceWorker' in navigator) { const regs = await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r => r.unregister().catch(()=>{}))); } } catch {}
        try {
          if (window.indexedDB && typeof indexedDB.databases === 'function') {
            const dbs = await indexedDB.databases();
            await Promise.all((dbs || []).map(db => {
              if (!db || !db.name) return Promise.resolve();
              return new Promise(res => { const req = indexedDB.deleteDatabase(db.name); req.onsuccess = req.onerror = req.onblocked = () => res(); });
            }));
          }
        } catch {}
        location.reload();
      }
      if (crachaEl) {
        let clicks = 0, firstTs = 0, TIMER = null, WINDOW_MS = 1200;
        crachaEl.addEventListener('click', async () => {
          const now = Date.now();
          if (!firstTs || now - firstTs > WINDOW_MS) { firstTs = now; clicks = 1; } else { clicks++; }
          clearTimeout(TIMER); TIMER = setTimeout(() => { clicks = 0; firstTs = 0; }, WINDOW_MS);
          if (clicks >= 3) {
            clicks = 0; firstTs = 0; clearTimeout(TIMER);
            const ok = confirm('Deseja limpar dados do aplicativo? (cache, SW, IndexedDB)');
            if (!ok) return;
            if (typeof window.resetAppData === 'function') { try { await window.resetAppData(); } catch {} }
            else { await fallbackReset(); }
          }
        });
      }
    })();
  </script>

  <!-- Save & restore launch context -->
  <script>
    (function(){
      const isStandalone = () =>
        (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone;
      try {
        if (location.search && !isStandalone()) {
          const ctx = { search: location.search, path: location.pathname || '/', ts: Date.now() };
          localStorage.setItem('pwa:lastCtx', JSON.stringify(ctx));
        }
      } catch {}
      try {
        const RESTORE_FLAG = 'pwa:restored';
        if (isStandalone() && !sessionStorage.getItem(RESTORE_FLAG)) {
          const raw = localStorage.getItem('pwa:lastCtx');
          if (raw) {
            const { search, path, ts } = JSON.parse(raw) || {};
            const ONE_WEEK = 7*24*60*60*1000;
            const fresh = !ts || (Date.now() - ts) < ONE_WEEK;
            if (fresh && search && path) {
              const target = path + search;
              const current = location.pathname + location.search;
              if (current !== target) {
                sessionStorage.setItem(RESTORE_FLAG, '1');
                location.replace(target);
              }
            }
          }
        }
      } catch {}
    })();
  </script>

  <!-- Profile cache API -->
  <script>
    (function(){
      const CACHE_NAME = 'cracha-user-v1';
      const PROFILE_JSON_PATH = '/offline/profile.json';
      const PROFILE_IMG_PATH  = '/offline/profile-photo.jpg';

      async function cacheUserProfile({ fullName, memberId, photoUrl }) {
        if (!fullName || !memberId || !photoUrl) { console.warn('[PWA] cacheUserProfile: dados faltando'); return; }
        const profile = { fullName, memberId, photoLocal: PROFILE_IMG_PATH, ts: Date.now() };
        const profileRes = new Response(JSON.stringify(profile), { headers: { 'Content-Type': 'application/json' } });

        const resp = await fetch(photoUrl);
        if (!resp.ok) throw new Error('Falha ao baixar foto');
        const photoBlob = await resp.blob();
        const photoRes = new Response(photoBlob, { headers: { 'Content-Type': photoBlob.type || 'image/jpeg' } });

        const cache = await caches.open(CACHE_NAME);
        await Promise.all([ cache.put(PROFILE_JSON_PATH, profileRes), cache.put(PROFILE_IMG_PATH,  photoRes) ]);
        localStorage.setItem('pwa:profileCached', '1');
        console.log('[PWA] Perfil salvo para uso offline');
      }

      async function loadUserProfile() {
        try {
          const cache = await caches.open(CACHE_NAME);
          const res = await cache.match(PROFILE_JSON_PATH);
          if (!res) return null;
          const profile = await res.json();
          return { ...profile, photoUrl: profile.photoLocal || PROFILE_IMG_PATH };
        } catch { return null; }
      }

      function getLaunchParams(){
        const params = new URLSearchParams(location.search);
        if ([...params].length) return params;
        try {
          const raw = localStorage.getItem('pwa:lastCtx'); if (!raw) return params;
          const { search } = JSON.parse(raw) || {};
          return search ? new URLSearchParams(search) : params;
        } catch { return params; }
      }

      window.cacheUserProfile = cacheUserProfile;
      window.loadUserProfile  = loadUserProfile;
      window.getLaunchParams  = getLaunchParams;
    })();
  </script>

  <!-- Toast API -->
  <script>
    (function(){
      function showToast({title, text, kind='info', ms=3500}){
        const wrap=document.getElementById('pwaToasts'); if(!wrap) return;
        const el=document.createElement('div'); el.className='pwa-toast '+kind;
        el.innerHTML=(title?'<div class="title">'+title+'</div>':'')+(text||'');
        wrap.appendChild(el);
        setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .2s'; }, Math.max(0,ms-180));
        setTimeout(()=>{ el.remove(); }, ms);
      }
      window.PWA_TOAST={ show:showToast };
    })();
  </script>

  <!-- Proc bar -->
  <script>
    (function(){
      const bar = document.getElementById('procBar');
      function showProc(text, kind='pending'){
        if(!bar) return;
        bar.className = 'proc-bar show proc-' + (kind==='pending'?'pending':kind);
        bar.textContent = text || '';
      }
      function hideProc(delayMs=1200){
        if(!bar) return;
        setTimeout(()=>{ bar.className = 'proc-bar'; bar.textContent=''; }, Math.max(0, delayMs));
      }
      window.PROC = {
        pending: (t='Aguarde: processando registro digital‚Ä¶') => showProc(t,'pending'),
        success: (t='Registro realizado com sucesso!') => { showProc(t,'success'); hideProc(); },
        queued:  (t='Sem internet: registro ser√° enviado quando a conex√£o voltar.') => { showProc(t,'queued'); hideProc(2000); },
        error:   (t='Falha ao processar. Tente novamente.') => { showProc(t,'error'); hideProc(2000); },
        show: showProc, hide: hideProc
      };
    })();
  </script>

  <!-- Fila / envio -->
  <script>
    (function(){
      const ENDPOINT = (typeof window.ENDPOINT === 'string' && window.ENDPOINT) || window.PRESENCE_ENDPOINT || '/api/presence';
      const DB_NAME = 'cracha-db'; const STORE = 'presenceQueue';

      function withDB(cb){
        return new Promise((resolve,reject)=>{
          const open=indexedDB.open(DB_NAME, 3);
          open.onupgradeneeded=()=>{ const db=open.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE,{keyPath:'id',autoIncrement:true}); };
          open.onsuccess=()=>cb(open.result).then(resolve,reject);
          open.onerror =()=>reject(open.error);
        });
      }
      function enqueue(payload){
        return withDB(db=>new Promise((res,rej)=>{
          const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).add({payload, createdAt:Date.now()});
          tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);
        })).then(()=>{ dispatchEvent(new CustomEvent('presence:queued', { detail: { payload } })); });
      }
      function allQueue(){
        return withDB(db=>new Promise((res,rej)=>{
          const out=[]; const tx=db.transaction(STORE,'readonly');
          const cursorReq = tx.objectStore(STORE).openCursor();
          cursorReq.onsuccess=()=>{ const c=cursorReq.result; if(c){ out.push({id:c.key, ...c.value}); c.continue(); } else res(out); };
          cursorReq.onerror=()=>rej(cursorReq.error);
        })).catch(async()=>{
          return withDB(db=>new Promise((res,rej)=>{
            const out=[]; const tx=db.transaction(STORE,'readonly'); const req=tx.objectStore(STORE).openCursor();
            req.onsuccess=()=>{ const c=req.result; if(c){ out.push({id:c.key, ...c.value}); c.continue(); } else res(out); };
            req.onerror=()=>rej(req.error);
          }));
        });
      }
      function removeId(id){
        return withDB(db=>new Promise((res,rej)=>{
          const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).delete(id);
          tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);
        }));
      }

      async function postForm(url, data, { timeoutMs=15000 }={}){
        const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
        try{
          const fd=new URLSearchParams(); Object.keys(data||{}).forEach(k=>fd.append(k, data[k]));
          const r=await fetch(url,{ method:'POST', body:fd, redirect:'follow', signal:ctrl.signal });
          if(!r.ok){ throw new Error('http-'+r.status); }
          return await r.text().catch(()=> '');
        } finally { clearTimeout(t); }
      }

      async function flushPresenceQueue(){
        const q = await allQueue();
        if(!q.length || !navigator.onLine) return;
        for (const it of q){
          try{
            await postForm(ENDPOINT, it.payload);
            await removeId(it.id);
            dispatchEvent(new CustomEvent('presence:sent', { detail: { id: it.id, payload: it.payload } }));
          } catch(e){ /* mant√©m na fila */ }
        }
        renderPending();
      }

      async function registerPresence(payload){
        const enriched = { ...payload, ua:navigator.userAgent, ts:Date.now() };
        if(navigator.onLine){
          try{
            await postForm(ENDPOINT, enriched);
            window.PWA_TOAST && PWA_TOAST.show({ title:'Presen√ßa', text:'Registro enviado com sucesso.', kind:'success' });
            flushPresenceQueue().catch(()=>{});
            dispatchEvent(new CustomEvent('presence:sent-now', { detail: { payload: enriched } }));
            return { ok:true, queued:false };
          }catch(e){
            console.warn('[PWA] Envio online falhou, enfileirando:', e);
          }
        }
        await enqueue(enriched);
        window.PWA_TOAST && PWA_TOAST.show({ title:'Presen√ßa', text:'Sem conex√£o. Registro salvo e ser√° enviado quando a conex√£o voltar.', kind:'warn', ms:5000 });
        renderPending();
        return { ok:false, queued:true };
      }

      (async function migrateLocalStorageQueueOnce(){
        try{
          const MIG_KEY='pwa:migrated:filaRegistros';
          if(localStorage.getItem(MIG_KEY)==='1') return;
          const raw=localStorage.getItem('filaRegistros'); if(!raw) return localStorage.setItem(MIG_KEY,'1');
          const arr=JSON.parse(raw||'[]'); if(Array.isArray(arr) && arr.length){ for(const r of arr){ try{ await enqueue(r); }catch{} } }
          localStorage.removeItem('filaRegistros'); localStorage.setItem(MIG_KEY,'1');
        }catch{}
      })();

      window.addEventListener('online', ()=> flushPresenceQueue().catch(()=>{}));
      window.addEventListener('load',  ()=> { if(navigator.onLine) flushPresenceQueue().catch(()=>{}); });

      const pendTbody = document.getElementById('tabela-pendentes');
      async function renderPending(){
        if(!pendTbody) return;
        const list = await allQueue();
        pendTbody.innerHTML = '';
        if(!list.length){ pendTbody.innerHTML = '<tr><td colspan="5" style="padding:8px">Sem pend√™ncias</td></tr>'; return; }
        list.sort((a,b)=>b.createdAt - a.createdAt).forEach(it=>{
          const { payload } = it;
          const tr = document.createElement('tr');
          const when = new Date(payload.ts || it.createdAt).toLocaleString('pt-BR');
          tr.innerHTML = `<td style="padding:8px">${when}</td><td style="padding:8px">${payload.nome||''}</td><td style="padding:8px">${payload.codigo||''}</td><td style="padding:8px">${payload.evento||''}</td><td style="padding:8px"><span class="badge" style="display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#eef2ff;color:#1d4ed8">aguardando</span></td>`;
          pendTbody.appendChild(tr);
        });
      }
      addEventListener('presence:queued', renderPending);
      addEventListener('presence:sent', renderPending);
      addEventListener('presence:sent-now', renderPending);
      window.addEventListener('online', renderPending);
      window.addEventListener('offline', renderPending);
      window.addEventListener('load', renderPending);

      window.registerPresence   = registerPresence;
      window.flushPresenceQueue = flushPresenceQueue;
      window.presenceQueueAPI   = { all: allQueue };
    })();
  </script>

  <!-- Sync banner + l√≥gica de estado -->
  <script>
    (function(){
      const $ = (sel) => document.querySelector(sel);
      const banner = $('#syncBanner');
      const btnNow = $('#syncNowBtn');
      const btnClose = $('#syncCloseBtn');
      const msg = $('#syncBannerMsg');
      const title = $('#syncTitle');

      const manualWrap = $('#manualNameWrap');
      const manualInput = $('#manualName');
      const manualSave = $('#manualNameSave');

      function showBanner(kind, text, autoHideMs){
        banner.classList.remove('ok','warn','err','info');
        banner.classList.add(kind);
        if (text) msg.textContent = text;
        banner.classList.add('show');
        banner.style.display='block';
        if (autoHideMs && kind==='ok'){
          setTimeout(()=>{ hideBannerSmooth(); }, autoHideMs);
        }
      }
      function hideBannerSmooth(){
        banner.classList.remove('show');
        setTimeout(()=>{ banner.style.display='none'; }, 200);
      }

      async function ensureProfileFromURL({ cleanQuery=true } = {}) {
        try {
          const getParams = () => (typeof window.getLaunchParams === 'function') ? window.getLaunchParams() : new URLSearchParams(location.search);
          const params = getParams();
          const fullName = params.get('name') || params.get('fullname') || params.get('nome');
          const memberId = params.get('memberId') || params.get('id') || params.get('matricula');
          let photo = params.get('photo') || params.get('foto') || params.get('image');
          if (!fullName || !memberId) return false;
          if (typeof window.cacheUserProfileSmart === 'function') {
            await window.cacheUserProfileSmart({ fullName, memberId, photo });
          }
          if (cleanQuery && (location.search || '').length > 1 && history.replaceState) { history.replaceState(null, '', location.pathname); }
          return true;
        } catch (e) { console.warn('[PWA] ensureProfileFromURL falhou:', e); return false; }
      }
      window.ensureProfileFromURL = ensureProfileFromURL;

      function readCurrentFields(){
        const nome = (window.currentData && currentData.name) || (document.getElementById('nome')?.value) || (document.getElementById('pName')?.textContent) || '';
        const codigo = (window.currentData && currentData.code) || (document.getElementById('codigo')?.value) || (document.getElementById('pCode')?.textContent) || '';
        const cleanNome = (nome||'').trim().replace(/^Nome$/,'');
        const cleanCodigo = (codigo||'').trim().replace(/^memberId$/,'');
        return { nome: cleanNome, codigo: cleanCodigo };
      }

      function setBanner(kind, text){
        showBanner(kind, text, kind==='ok' ? 1600 : undefined);
        title.textContent = (kind==='ok'?'Sincronizado':kind==='warn'?'Aguardando sincroniza√ß√£o':'Sincroniza√ß√£o necess√°ria');
        manualWrap.style.display = (kind==='err') ? 'flex' : 'none';
      }

      async function updateSyncStatus(){
        const { nome, codigo } = readCurrentFields();
        if (nome && codigo){ setBanner('ok', 'Seus dados foram carregados. Tudo certo!'); return; }
        if (nome || codigo){ setBanner('warn', 'Dados parciais encontrados. Aguarde a sincroniza√ß√£o autom√°tica‚Ä¶'); return; }
        setBanner('err', 'Nenhum dado encontrado. Sincronize ou informe seu nome completo para come√ßar.');
      }
      window.updateSyncStatus = updateSyncStatus;

      manualSave?.addEventListener('click', ()=>{
        const v = (manualInput?.value||'').trim();
        if (!v || v.length < 3){ msg.textContent = 'Digite um nome v√°lido.'; return; }
        try{ localStorage.setItem('pwa:manualName', v); }catch{}
        const currentCode = (window.currentData && currentData.code) || '';
        setBadgeData(v, currentCode, (window.currentData && currentData.photoUrl) || '');
        const nomeInput = document.getElementById('nome'); if (nomeInput) nomeInput.value = v;
        updateSyncStatus();
      });

      async function trySyncNow(){
        await window.ensureProfileFromURL({ cleanQuery:false });
        await updateSyncStatus();
      }

      // üîß Ajuste: bot√£o "Sincronizar" tamb√©m tenta enviar a fila offline
      btnNow && btnNow.addEventListener('click', async () => {
        await trySyncNow();
        if (navigator.onLine && typeof window.flushPresenceQueue === 'function') {
          try { await window.flushPresenceQueue(); } catch {}
        }
      });
      btnClose && btnClose.addEventListener('click', hideBannerSmooth);

      window.addEventListener('online', updateSyncStatus);
      window.addEventListener('offline', updateSyncStatus);
      window.addEventListener('load', async () => {
        if (navigator.onLine) { await trySyncNow(); } else { await updateSyncStatus(); }
      });
    })();
  </script>

  <!-- Install banner + SW -->
  <script>
    (function(){
      const banner = document.getElementById('pwaBanner');
      const installBtn = document.getElementById('pwaInstallBtn');
      const closeBtn = document.getElementById('pwaCloseBtn');
      const hint = document.getElementById('pwaHint');

      const isStandalone = () => (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone;
      const UA = navigator.userAgent.toLowerCase();
      const isIOS = /iphone|ipad|ipod/.test(UA);
      const isAndroid = /android/.test(UA);
      const isSafari = /^((?!chrome|crios|fxios|edgios|android).)*safari/.test(navigator.userAgent);
      const isChrome = /chrome|crios/.test(navigator.userAgent) && !/edg/i.test(navigator.userAgent);
      const isEdge = /edg\//i.test(navigator.userAgent);

      let deferredPrompt;

      function showBanner(){ if (!isStandalone()) { banner.classList.add('show'); banner.style.display='block'; } }
      function hideBanner(){ banner.classList.remove('show'); setTimeout(()=>{ banner.style.display='none'; }, 200); }

      function setHintTextForPlatform() {
        if (isIOS && isSafari) { hint.innerHTML = 'iPhone/iPad: Compartilhar ‚Üí <strong>Adicionar √† Tela de In√≠cio</strong>.'; return; }
        if (!isIOS && isSafari){ hint.innerHTML = 'Safari (macOS): Arquivo ‚Üí <strong>Adicionar √† Dock</strong>.'; return; }
        if (isAndroid && isChrome){ hint.innerHTML = 'Android/Chrome: menu ‚ãÆ ‚Üí <strong>Instalar app</strong>.'; return; }
        if (isAndroid && isEdge){ hint.innerHTML = 'Android/Edge: menu ‚ãÆ ‚Üí <strong>Instalar este site como app</strong>.'; return; }
        hint.textContent = 'Procure ‚Äúinstalar/adicionar √† tela inicial‚Äù no menu do navegador.';
      }

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); deferredPrompt = e;
        setHintTextForPlatform(); installBtn.style.display = 'inline-block'; showBanner();
      });

      window.addEventListener('load', () => {
        if (isStandalone()) return;
        setTimeout(() => { if (!deferredPrompt) { setHintTextForPlatform(); installBtn.style.display = 'none'; showBanner(); } }, 1800);
      });

      installBtn?.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        hideBanner();
      });

      closeBtn?.addEventListener('click', hideBanner);

      window.addEventListener('appinstalled', () => {
        hideBanner();
        window.PWA_TOAST && PWA_TOAST.show({ title:'Instala√ß√£o', text:'App instalado com sucesso.', kind:'success' });
      });

      // Mantido o registro do SW aqui, com escopo raiz
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.getRegistration().then(reg => {
            if (!reg) navigator.serviceWorker.register('/sw.js', { scope: '/' }).catch(()=>{});
          });
        });
      }
    })();
  </script>
</body>
</html>
