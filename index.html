<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crachá Digital — Frente/Verso (offline + câmera)</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#111111">

  <!-- iOS / Safari -->
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Crachá">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <!-- Fonts (offline cai para system-ui) -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <!-- LIBS LOCAIS (para offline) -->
  <script src="/vendor/html5-qrcode.min.js" defer></script>
  <script src="/vendor/qrcode.min.js" defer></script>
  <script src="/vendor/html2canvas.min.js" defer></script>
  <script src="/vendor/jspdf.umd.min.js" defer></script>
  <script src="/vendor/JsBarcode.all.min.js" defer></script>

  <style>
 :root{
  --preview-scale: .38;
  --primary:#1e88e5; --text:#111; --muted:#9aa0a6;
  --card-w:638px; --card-h:1011px;

  /* BOTÃO “tamanho de polegar” */
  --fab-size: 72px;

  --qr-height: 260px;

  /* Paleta banners (translúcidos/sem borda) */
  --ok-bg-rgb:   34,197,94;
  --warn-bg-rgb: 251,191,36;
  --err-bg-rgb:  239,68,68;
  --info-bg-rgb: 59,130,246;

  --ok-fg:#d7fde7;
  --warn-fg:#fff7da;
  --err-fg:#ffe7e7;
  --info-fg:#e7f0ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:#E8E6E6;margin:0;color:#111;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;

  /* Ancoragem estável para não “descer” ao virar */
  min-height:100dvh;
  display:flex;align-items:flex-start;justify-content:center;
  padding:12px;
  overflow-anchor:none;
}
.wrap{width:100%;max-width:1100px}

/* Cartão responsivo mantendo proporção */
.preview-wrap{
  width:calc(var(--card-w)*var(--preview-scale));
  height:calc(var(--card-h)*var(--preview-scale));
  margin:0 auto;position:relative;perspective:1200px;
  transition:width .2s ease,height .2s ease;
  overflow:hidden;                    /* impede “descer” */
  contain:layout paint size;          /* evita empurrões */
}
.card-3d{position:absolute;inset:0;transform-style:preserve-3d;will-change:transform}

/* === Frente/Verso empilhados (o verso não some) === */
.card,.back{
  position:absolute; inset:0;
  width:var(--card-w);height:var(--card-h);transform-origin:top left;
  backface-visibility:hidden;border-radius:28px;color:#fff;overflow:hidden;
  background:#333;background-size:cover;background-position:center;
  padding:14px;box-shadow:0 4px 12px rgba(0,0,0,.15);
  transform:translateZ(0) scale(var(--preview-scale)) rotateY(0deg);
  transition: transform .7s cubic-bezier(.2,.7,.2,1), opacity .25s ease;
  will-change: transform, opacity;
  z-index:1;
}
.back{
  transform:translateZ(0) scale(var(--preview-scale)) rotateY(180deg);
  opacity:0; z-index:1;
  display:grid; /* mantém layout do verso */
}
.card-3d.is-back .card{
  opacity:0; pointer-events:none;
  transform:translateZ(0) scale(var(--preview-scale)) rotateY(180deg);
  z-index:1;
}
.card-3d.is-back .back{
  opacity:1;
  transform:translateZ(0) scale(var(--preview-scale)) rotateY(0deg);
  z-index:2;
}

/* Fundo sempre no nível mais baixo */
.bg-layer{
  position:absolute;inset:0;background-size:cover;background-position:center;border-radius:28px;
  z-index:0;               /* <- antes era 1 */
  pointer-events:none;     /* não bloqueia cliques */
}

/* Todo o conteúdo acima do fundo */
.card > *:not(.bg-layer),
.back > *:not(.bg-layer){
  position:relative;
  z-index:2;
}
/* QR pode ficar um nível acima se quiser garantir */
.qr-section{ margin-top: 12px;margin-bottom: 54px;z-index:3; }

.brand-row{display:flex;justify-content:center;align-items:center;min-height:80px}
.logo-main{max-height:220px;max-width:90%;display:block;filter:brightness(1.05)}

.profile-block{display:grid;justify-items:center;row-gap:0;margin-top:-6px;padding:0 12px}
.photo{width:min(40%,240px);aspect-ratio:1/1;border-radius:999px;object-fit:cover;border:4px solid rgba(255,255,255,.85);background:rgba(255,255,255,.1)}
.info{position: relative; z-index: 4;text-align:center}
.name{font-size:clamp(20px,3.4vw,44px);font-weight:700;margin:12px 0 0;line-height:1.05;text-shadow:0 1px 4px rgba(0,0,0,.35)}
.name .name-2{display:block;opacity:.98}

/* Código (memberId) — texto simples sob o nome */
.code{
  font-size:clamp(10px,1.8vw,14px);
  margin:6px 0 0; padding:0;
  opacity:.01; text-shadow:0 1px 2px rgba(0,0,0,.25);
  border:0; background:transparent; display:block;
  letter-spacing:.2px;
}

.qr-section{z-index:3;display:grid;place-items:center;padding:8px 4px;margin-top:-20px;margin-bottom:54px}
.qr{
  display:inline-grid;
  background:#fff;
  border-radius:16px;
  padding:10px;
  width:auto;
  justify-items:center;
  align-items:center;
  line-height:0;
}
.qr img, .qr canvas{ display:block; }

/* Código de barras vertical */
.barcode-rail{position:absolute;right:10px;top:5%;transform:translateY(-50%);z-index:2;pointer-events:none}
.barcode-rot{display:inline-block;transform:rotate(-90deg);transform-origin:right center}

.footer-row{z-index:1;display:flex;align-items:center;justify-content:center;gap:10px;padding:8px 10px;margin-bottom:10px;position:relative;flex-wrap:wrap}
.foot-logo{max-height:60px;max-width:40%}
.footer-text{font-size:12px;line-height:1.35;max-width:360px;text-shadow:0 1px 3px rgba(0,0,0,.35)}
.protocol{position:absolute;bottom:-24px;left:50%;transform:translateX(-50%);font-size:10px;background:rgba(150,29,19,.9);padding:4px 10px;border-radius:8px;white-space:nowrap}

/* FABs */
.fab{
  position:absolute;
  right:18px;
  left:auto;
  bottom:18px;
  z-index:10;
  width:var(--fab-size);
  height:var(--fab-size);
  border-radius:999px;
  border:0;
  cursor:pointer;
  background:rgba(255,255,255,.92);
  color:#111;
  display:grid;
  place-items:center;
  box-shadow:0 8px 24px rgba(0,0,0,.25);
  transition:transform .15s ease,opacity .15s ease,background .2s;
  touch-action: manipulation;
}
/* Apenas o botão da frente */
#cardFront .fab{
  right:auto;
  left:500px;
  top:750px;
  bottom:auto;
}
.fab:hover{transform:translateY(-1px)}
.fab svg{width:32px;height:32px;display:block}
.fab.secondary{right:18px;left: auto;bottom: 18px;background:rgba(255,255,255,.92)}

/* Verso com rolagem interna e barra oculta */
.back .content-scroll{
  z-index:2;position:relative;overflow:auto;
  padding:16px;height:100%;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
  scrollbar-width: none;
}
.back .content-scroll::-webkit-scrollbar{width:0;height:0}

.badge-panel{
  width:100%;max-width:600px;margin:0 auto;background:rgba(0,0,0,0.18);
  backdrop-filter: blur(6px);
  border-radius:16px;padding:16px;display:grid;gap:12px;color:#fff;font-family:'Inter',sans-serif
}
.badge-logo img{max-width:80%}
.badge-status{font-size:13px;color:#f1f5f9;text-align:center;min-height:18px}

.badge-form label{font-size:13px;color:#fff}
.badge-form input,.badge-form button{
  width:100%;padding:12px;margin-top:6px;border-radius:14px;border:1px solid rgba(255,255,255,.24);
  font-size:14px;background:rgba(255,255,255,.10);color:#fff;outline:none;
  transition:border-color .2s,background .2s,box-shadow .2s;
}
.badge-form input:focus{border-color:#fff;box-shadow:0 0 0 2px rgba(255,255,255,.15) inset}
.badge-form input[readonly]{background:rgba(255,255,255,.08);color:#e7e7e7}
.badge-form button{background:#A40000;font-weight:600;cursor:pointer}
.badge-form button:hover{background:#7a0000}
.badge-msg{min-height:20px;text-align:center;font-weight:600;color:#e5e7eb}
.badge-msg.error{color:#fecaca}

/* Leitor: tamanho final padronizado (vídeo também) */
#reader{
  width:100%; height:var(--qr-height);
  border-radius:16px; background:rgba(255,255,255,.08);
  overflow:hidden;
}

/* -------- BANNERS -------- */
.pwa-banner{
  position:fixed;
  left:50%;
  transform:translateX(-50%) translateY(-12px);
  top:12px;
  z-index:9998;
  width:calc(var(--card-w) * var(--preview-scale));
  max-width:none;
  border-radius:14px;
  padding:12px 14px;
  box-shadow:0 20px 60px rgba(0,0,0,.22);
  display:none;
  opacity:0;
  transition:opacity .25s ease, transform .25s ease;
  font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:rgba(var(--info-bg-rgb), .28);
  backdrop-filter:blur(4px);
  font-size: clamp(12px, 2.6vw, 16px);
}
.pwa-banner.show{ display:block; opacity:1; transform:translateX(-50%) translateY(0); }
.pwa-banner .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.pwa-banner .title{font-weight:600;display:flex;align-items:center;gap:8px}
.pwa-banner .hint{opacity:.95}
.pwa-banner .dot{width:10px;height:10px;border-radius:50%;display:inline-block;box-shadow:0 0 0 2px rgba(255,255,255,.35) inset}
.pwa-banner .actions{display:flex;gap:8px;align-items:center}
.pwa-banner button{border:0;border-radius:10px;padding:8px 12px;cursor:pointer;background:rgba(255,255,255,.12);color:#fff}
.pwa-banner button.ghost{background:rgba(255,255,255,.08)}
.pwa-banner.ok   { background:rgba(var(--ok-bg-rgb), .18);   color:var(--ok-fg); }
.pwa-banner.warn { background:rgba(var(--warn-bg-rgb), .20); color:var(--warn-fg); }
.pwa-banner.err  { background:rgba(var(--err-bg-rgb), .20);  color:var(--err-fg); }
.pwa-banner.info { background:rgba(var(--info-bg-rgb), .18); color:var(--info-fg); }
.pwa-banner.ok .dot{background:rgba(var(--ok-bg-rgb), .95)}
.pwa-banner.warn .dot{background:rgba(var(--warn-bg-rgb), .95)}
.pwa-banner.err .dot{background:rgba(var(--err-bg-rgb), .95)}
.pwa-banner.info .dot{background:rgba(var(--info-bg-rgb), .95)}

.pwa-banner .inline-form{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
.pwa-banner input[type="text"]{
  padding:8px 10px;border-radius:10px;border:0;
  background:rgba(255,255,255,.12);color:inherit;min-width:200px;outline:none
}

/* Install banner translúcido */
.pwa-install-banner{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:16px;
  z-index:9997;
  width:calc(var(--card-w) * var(--preview-scale));
  max-width:none;
  background:rgba(var(--info-bg-rgb), .36);
  color:#e7f0ff;
  padding:12px 14px;
  border-radius:14px;
  box-shadow:0 20px 60px rgba(0,0,0,.22);
  display:none;
  opacity:0;
  transition:opacity .25s ease, transform .25s ease;
  backdrop-filter:blur(4px);
  font-size: clamp(12px, 2.6vw, 16px);
}
.pwa-install-banner.show{display:block;opacity:1}
.pwa-install-banner .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.pwa-install-banner button{border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
.pwa-install-banner .install{background:rgba(255,255,255,.16);color:#fff}
.pwa-install-banner .close{background:rgba(255,255,255,.08);color:#dbeafe}

/* Toasts / Proc */
.pwa-toasts{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:10000;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.pwa-toast{min-width:260px;max-width:90vw;background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);font:14px/1.35 system-ui;pointer-events:auto}
.pwa-toast.success{background:#115e24}.pwa-toast.warn{background:#8a1d1d}.pwa-toast.info{background:#0b57d0}
.pwa-toast .title{font-weight:600;margin-bottom:2px}

.proc-bar{position:fixed;left:50%;transform:translateX(-50%);top:64px;z-index:10001;min-width:280px;max-width:90vw;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);font:14px/1.35 system-ui;color:#111;display:none}
.proc-bar.show{display:block}
.proc-pending{background:#fde68a;border:1px solid #f59e0b}
.proc-success{background:#bbf7d0;border:1px solid #22c55e}
.proc-queued{background:#dbeafe;border:1px solid #3b82f6}
.proc-error{background:#fecaca;border:1px solid #ef4444}

    /* Loader overlay */
    .loader{position:fixed;inset:0;background:linear-gradient(180deg,#0f0f10,#1b1b1c);
      display:flex;align-items:center;justify-content:center;color:#fff;z-index:100000}
    .loader .dot{width:10px;height:10px;border-radius:50%;background:#fff;opacity:.85;animation:bounce .9s infinite alternate}
    .loader .dot:nth-child(2){margin:0 10px;animation-delay:.15s}
    .loader .dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{to{transform:translateY(-8px);opacity:1}}

    @media (max-width:1200px){ :root{ --preview-scale: .34 } }
    @media (max-width:920px){  :root{ --preview-scale: .30 } }
    @media (max-width:720px){  :root{ --preview-scale: .26 } }
    @media (max-width:600px){  :root{ --preview-scale: .22 } }
    @media (max-width:480px){  :root{ --preview-scale: .195 } }
    @media (max-width:400px){  :root{ --preview-scale: .175 } }
  </style>
</head>
<body>
  <!-- LOADING -->
  <div id="loader" class="loader" aria-live="polite" aria-busy="true">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>

  <div class="wrap">
    <div class="preview-wrap" id="previewWrap">
      <div class="card-3d" id="card3d">
        <!-- FRENTE -->
        <div class="card" id="cardFront" aria-label="Crachá — Frente">
          <div class="bg-layer" id="bg"></div>

          <!-- FAB frente -->
          <button class="fab" id="flipToBack" title="Registrar presença" aria-label="Registrar presença">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4.93 4.93a10 10 0 1 1 0 14.14"></path>
              <path d="M4 10v6h6"></path>
            </svg>
          </button>

          <div class="brand-row">
            <img class="logo-main" id="logoMain" alt="Logo principal">
          </div>

          <div class="profile-block">
            <img class="photo" id="pPhoto" alt="Foto">
            <div class="info">
              <h3 class="name" id="pName">Nome</h3>
              <p class="code" id="pCode">memberId</p>
            </div>
          </div>

          <div class="qr-section"><div class="qr" id="qr"></div></div>

          <div class="barcode-rail"><div class="barcode-rot"><svg id="barcode"></svg></div></div>

          <div class="footer-row">
            <img class="foot-logo" id="foot1" alt="Logo 1">
            <img class="foot-logo" id="foot2" alt="Logo 2">
            <div class="footer-text" id="footText">Crachá digital pessoal e intransferível, válido somente para este evento.</div>
            <div class="protocol" id="protocolText"></div>
          </div>
        </div>

        <!-- VERSO -->
        <div class="back" id="cardBack" aria-label="Crachá — Verso">
          <div class="bg-layer" id="bgBack"></div>

          <!-- FAB verso -->
          <button class="fab secondary" id="flipToFront" style="display:none" title="Voltar ao crachá" aria-label="Voltar ao crachá">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>

          <!-- conteúdo rolável -->
          <div class="content-scroll">
            <div class="badge-panel">
              <div class="badge-logo">
                <img src="./logo-evento.png" alt="Logo do Evento" onerror="this.style.display='none'">
              </div>

              <div class="badge-status" id="statusBar"></div>

              <div class="badge-reader"><div id="reader"></div></div>

              <form id="form" class="badge-form" autocomplete="off">
                <label for="nome">Nome</label>
                <input type="text" id="nome" name="nome" placeholder="Nome" required readonly>

                <label for="codigo">Código (memberId)</label>
                <input type="text" id="codigo" name="codigo" placeholder="Código (memberId)" required readonly>

                <label for="evento">Evento (QR)</label>
                <input type="text" id="evento" name="evento" placeholder="Aproxime o QR do evento" required readonly inputmode="none">
                <div class="hint" style="font-size:12px;color:#e5e7eb;margin-top:6px">O evento só é preenchido ao ler o QR Code do evento.</div>

                <button type="submit" id="enviarBtn">Enviar registro digital de presença</button>
              </form>

              <p id="msg" class="badge-msg"></p>

              <div id="lista-pendentes">
                <h3 style="margin:2px 0 6px">Registros pendentes de envio</h3>
                <div class="table-scroll" style="border:1px solid rgba(255,255,255,.25);border-radius:14px;overflow:hidden;background:rgba(0,0,0,.15)">
                  <table style="width:100%;border-collapse:collapse;color:#fff">
                    <thead>
                      <tr>
                        <th style="width:28%;padding:8px;background:rgba(0,0,0,.35);position:sticky;top:0">Data/Hora</th>
                        <th style="width:22%;padding:8px;background:rgba(0,0,0,.35);position:sticky;top:0">Nome</th>
                        <th style="width:18%;padding:8px;background:rgba(0,0,0,.35);position:sticky;top:0">Código</th>
                        <th style="width:22%;padding:8px;background:rgba(0,0,0,.35);position:sticky;top:0">Evento</th>
                        <th style="width:10%;padding:8px;background:rgba(0,0,0,.35);position:sticky;top:0">Status</th>
                      </tr>
                    </thead>
                    <tbody id="tabela-pendentes" style="display:block;max-height:170px;overflow:auto"></tbody>
                  </table>
                </div>
              </div>

              <div id="lista-registros" style="display:none">
                <h3>Presenças Registradas</h3>
                <table>
                  <thead><tr><th>Data/Hora</th><th>Nome</th><th>Código</th><th>Evento</th></tr></thead>
                  <tbody id="tabela-registros"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div><!-- /back -->
      </div>
    </div>
  </div>

  <!-- Toasts / Proc -->
  <div id="pwaToasts" class="pwa-toasts" aria-live="polite" aria-atomic="true"></div>
  <div id="procBar" class="proc-bar" role="status" aria-live="polite"></div>

  <!-- Sync banner -->
  <div id="syncBanner" class="pwa-banner" role="region" aria-label="Sincronização">
    <div class="row">
      <div class="title">
        <span class="dot" id="syncDot"></span>
        <span id="syncTitle">Sincronização</span>
      </div>
      <div class="actions">
        <button id="syncNowBtn" class="ghost">Sincronizar</button>
        <button id="syncCloseBtn" class="ghost">Fechar</button>
      </div>
    </div>
    <div id="syncBannerMsg" class="hint" style="margin-top:6px">Verificando status…</div>

    <div id="manualNameWrap" class="inline-form" style="display:none">
      <label for="manualName" style="opacity:.95">Nome completo:</label>
      <input type="text" id="manualName" placeholder="Digite seu nome completo" />
      <button id="manualNameSave" class="ghost">Salvar</button>
    </div>
  </div>

  <!-- Install banner -->
  <div id="pwaBanner" class="pwa-install-banner" role="region" aria-label="Instalar aplicativo">
    <div class="row">
      <div>
        <div class="title">Instale “Crachá Digital - IISNHCM”</div>
        <div id="pwaHint" class="hint"></div>
      </div>
      <div>
        <button id="pwaInstallBtn" class="install" style="display:none">Instalar app</button>
        <button id="pwaCloseBtn" class="close" aria-label="Fechar">Agora não</button>
      </div>
    </div>
  </div>

  <audio id="bip" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <!-- App (toda a lógica fica aqui) -->
  <script src="/app.js" defer></script>
</body>
</html>
